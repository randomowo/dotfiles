#!/bin/bash
# battery capacity notifyer
# by randomowo <randomowo@ya.ru>

beep=~/music/sfx/trumpet.flac
maxcap=$((( $(cat /sys/class/power_supply/BAT0/charge_full) * 100 / $(cat /sys/class/power_supply/BAT0/charge_full_design) )))
flag=0
while [[ 1 ]]; do
	cap=$(cat /sys/class/power_supply/BAT0/capacity)
	status=$(cat /sys/class/power_supply/BAT0/status)
	if [[ $status == "Discharging" ]]; then
		if ((( $flag == 0 )) || (( $flag == 3 ))); then flag=1; fi
	elif (( $flag != 0 )) && (( $flag != 3 )); then
		flag=0
		if (( $cap < ($maxcap - 10) )); then
			sleep 5
			timeToFull=$(acpi | cut -d" " -f5)
			notify-send -u normal "Time to full battery charge $timeToFull"
		fi
	fi
	case $flag in
		0)
			if (( $cap > $maxcap )); then
				notify-send -u normal "Battery fully charged"
				flag=3
			fi
			;;
		1)
			if (( $cap < 20 )) && (( $cap > 5 )); then
				notify-send -u critical -t 5000 "Battery capacity below 20%" && mpv $beep
				flag=2
			fi
			;;
		2)
			if (( $cap < 5 )); then
				notify-send -u critical -t 10000 "Battery capacity below 5%" && mpv $beep
				flag=-1
			fi
			;;
		*)
			continue;;
	esac
	sleep 600
done

exit 0
